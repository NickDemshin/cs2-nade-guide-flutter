# CS Nade Guide (Flutter)

Приложение‑гайд по гранатам для карт CS2. Показывает точки приземления и места броска на схеме карты, позволяет фильтровать по типу и стороне, отмечать избранное и открывать видео. Поддерживает добавление/редактирование пользовательских меток прямо из приложения.

## Возможности
- Список карт и счётчик гранат на каждую.\n- Категории на главной: вкладки «Турнирные», «Остальные», «Избранные». Избранное для карт сохраняется локально.
- Экран карты: точки приземления, линия «откуда → куда», панорамирование/масштабирование.
- Кластеризация меток: близкие точки одного типа объединяются в одну иконку. Тап открывает компактный popover со списком точек.
- Понятные метки: разные формы/иконки по типам (Smoke/Flash/Molotov/HE), лёгкая анимация «пульс» при выборе.\n- Легенда типов на карте (можно скрывать программно), режим палитры для дальтоников.
- Фильтры: по типу гранаты (Smoke/Flash/Molotov/HE) и по стороне (T/CT/Both), «только избранные».
- Избранное сохраняется локально (SharedPreferences).
- Открытие видео‑гайда во внешнем приложении.
- Режим «координаты»: долгий тап по карте копирует нормированные координаты (0..1) в буфер обмена — удобно для ручного ввода.
- Добавление/редактирование/удаление пользовательских гранат: выбор координат тапом по карте, форма с полями, сохранение в локальный JSON.

## Структура проекта (важные файлы)
- `lib/main.dart` — вход приложения.
- `lib/pages/home_page.dart` — список карт.
- `lib/pages/map_page.dart` — экран карты, фильтры, избранное, детали, режим координат.
- `lib/widgets/map_board.dart` — отрисовка фона, сетки, маркеров и линии.
- `lib/models/cs_map.dart`, `lib/models/nade.dart` — модели данных.
- `lib/data/nades_repository.dart` — загрузка данных из ассетов + пользовательских файлов, запись/обновление/удаление пользовательских меток.
- `assets/data/` — JSON‑данные карт и гранат.
- `assets/images/maps/` — фоновые изображения карт (png).

## Данные и формат JSON
Ассеты подключены в `pubspec.yaml` (директории `assets/data/` и `assets/images/maps/`).

Карты: `assets/data/maps.json`
```json
{
  "maps": [
    { "id": "mirage", "name": "Mirage", "image": "assets/images/maps/mirage.png" },
    { "id": "inferno", "name": "Inferno" }
  ]
}
```

Гранаты: `assets/data/nades_<mapId>.json` (пример `nades_mirage.json`)
```json
{
  "nades": [
    {
      "id": "mirage_smoke_window_tspawn",
      "title": "Окно из респа T",
      "type": "smoke",            // smoke | flash | molotov | he
      "side": "T",                 // T | CT | Both
      "from": "Респаун T",
      "to": "Окно мида",
      "technique": "jumpthrow",
      "fromX": 0.15, "fromY": 0.85, // 0..1 — нормированные координаты на карте
      "toX": 0.52,   "toY": 0.35,
      "videoUrl": "https://…",
      "description": "Комментарий"
    }
  ]
}
```

Нормированные координаты: 0 — левая/верхняя граница, 1 — правая/нижняя. Визуализация использует одинаковое соотношение сторон (1:1); рекомендуется подготавливать квадратные схемы карт.

Пользовательские точки: файл `nades_<mapId>.user.json` создаётся в директории документов приложения и имеет такую же структуру (`{"nades": [...]}`). При загрузке репозиторий объединяет данные из ассетов и пользовательского файла.

## Как добавить новую карту и точки
1) Картинка (необязательно): положите файл в `assets/images/maps/` (например, `anubis.png`). 1024×1024 подойдёт.
2) Добавьте запись в `assets/data/maps.json`:
```json
{ "id": "anubis", "name": "Anubis", "image": "assets/images/maps/anubis.png" }
```
3) Создайте `assets/data/nades_anubis.json` с массивом `nades` по схеме выше.
4) Hot reload или перезапуск — карта появится в списке.

Подсказка: включите иконку «Координаты» на экране карты, затем долгим тапом по схеме копируйте `x/y` в буфер — используйте значения для `fromX/fromY` и `toX/toY` в JSON.

## Как добавить гранату из приложения\n\n### UX/управление на карте\n- Плавающая панель инструментов (справа сверху): сетка, координаты, цвета для дальтоников, сброс зума.\n- Удобный выбор координат: отдельный полноэкранный «пикер» — тап по карте возвращает x/y в форму.\n\n1) Откройте карту и нажмите кнопку `+` (в правом нижнем углу).
2) Заполните поля: название, тип, сторона, откуда/куда (описания), техника, при желании видео/описание.
3) Нажмите «Выбрать на карте» рядом с «Коорд. приземления» и тапните по карте — координаты заполнятся автоматически.
4) Аналогично выберите «Коорд. броска».
5) Нажмите «Сохранить». Метка появится на карте и сохранится в `nades_<mapId>.user.json`.

Редактирование/удаление: выберите метку на карте — внизу появится карточка. Для пользовательских меток будут кнопки «Редактировать» и «Удалить».\n\nВажно: удалить можно только пользовательские метки (id начинается с user_). Точки из ассетов не редактируются и не удаляются из приложения.

Где хранится: пользовательские метки сохраняются в файле `nades_<mapId>.user.json` в каталоге документов приложения (см. `path_provider/getApplicationDocumentsDirectory`).

## Сборка и запуск
Требуется Flutter SDK (см. `environment.sdk` в `pubspec.yaml`).

Команды:
- `flutter pub get`
- `flutter run`

Зависимости, важные для пользовательских меток:
- `path_provider` — доступ к каталогу документов для чтения/записи `nades_<mapId>.user.json`.

## Частые проблемы
- Пустой экран карты: проверьте, что для карты существует `assets/data/nades_<id>.json` и JSON корректный.
- Фон не отображается: проверьте путь `image` в `maps.json` и наличие файла в `assets/images/maps/`.
- Открытие видео: для Android/iOS требуется наличие внешнего браузера/YouTube‑клиента.
- Добавленные метки не сохраняются: убедитесь, что приложение имеет доступ к файловой системе (мобильные ОС) и не работает в web‑сборке без реализации хранения.\n- Ошибка удаления «Cannot remove from a fixed-length list»: обновлено — пользовательские списки теперь изменяемые. Если ошибка повторяется, проверьте, что удаляется именно user_‑метка.



